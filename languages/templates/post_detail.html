{% extends 'base.html' %}
{% block og %}
<!--
    <meta property="og:type" content="article" />
    <meta property="og:url" content="https://dev.to/earthcomfy/getting-started-custom-user-model-5hc" />
    <meta property="og:title" content="Custom User Model in Django" />
    <meta property="og:description" content="Hello everyone. Follow this article to understand about custom user model in Django.     I&#39;ve..." />
    <meta property="og:site_name" content="DEV Community" />
    <meta name="twitter:site" content="@thepracticaldev">
    <meta name="twitter:creator" content="@earthcomfy">
    <meta name="twitter:title" content="Custom User Model in Django">
    <meta name="twitter:description" content="Hello everyone. Follow this article to understand about custom user model in Django.     I&#39;ve...">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:widgets:new-embed-design" content="on">
    <meta name="robots" content="max-snippet:-1, max-image-preview:large, max-video-preview:-1">
    <meta property="og:image" content="https://dev.to/social_previews/article/1024949.png" />
    <meta name="twitter:image:src" content="https://dev.to/social_previews/article/1024949.png">
-->
{% endblock og %}

{% block body %}
{% include 'static/css/styles.html' %}
{% include "header.html" %}

{% include 'messages.html' %}

<div class="container my-5">
    {% if perms.languages.change_post %}
        <div class="row">
            <div class="col-auto">
                <button class="btn btn-outline-secondary" onclick="window.location.assign(`{% url 'post_entry' %}?action=editpost&pk={{post.pk}}`)">Edit Post</button>
                <button class="btn btn-outline-secondary" onclick="window.location.assign(`{% url 'exercise_entry' %}`)">Add Exercise</button>
            </div>
        </div>
        <hr>
    {% endif %}
    
    <div id="post-title">
        <div class="d-flex justify-content-between">
            <div>
                <h2>{{ post.title }}</h2>
                <div id="post-stamp">Posted on {{post.date_created}} by {{post.author}}</div>
            </div>
            <div>{% include 'static/components/like_dislike.html' %}</div>
        </div>
    </div>

    <div class="rule"></div>

    <div id="post-content" class="mb-5">
        {{ post.content|safe }}
    </div>
    
    <h3><i class="fa-solid fa-dumbbell"></i> Exercise <i class="fa-solid fa-dumbbell"></i></h3>
    <hr>
    <b>Choose the correct word to fill the blanks</b> ({{post.fill_values}}):
    <div id="exercise" class="my-4 position-relative">
        {% if not premium %}
        <div class="intr">
            <div class="col"><i class="fa-solid fa-lock"></i> You need premium membership for this</div>
            <div card="col"><button class="btn btn-primary">Get it</button></div>
        </div>
        {% endif %}
        <!-- Result Prompt <div class="hidden">
            <div class="intr">
                <div id="result">That was awesome!</div>
            </div>
        </div>-->
        <!-- Modal -->
        <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel">Result:</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div id="modal-body" class="modal-body">
                    ...
                    </div>
                    <div class="modal-footer border-0">
                        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Okay</button>
                    </div>
                </div>
            </div>
        </div>
        <div id="questions">
            <ol>
                {% for q in post.exercise_set.all %}
                    <li class="mb-2">{{q.question}}</li>
                {% endfor %}
            </ol>
        </div>
    </div>
    <div class="row my-5">
        <div class="col-auto">
            <button onclick="check()" class="btn btn-primary px-4" data-bs-toggle="modal" data-bs-target="#exampleModal">Check</button>
        </div>
        <div class="col-auto">
            <button class="btn btn-outline-secondary px-4">Show answers</button>
        </div>
    </div>
    <hr>
    <div class="text-center">
    {% include 'static/components/like_dislike.html' %} {% include 'static/components/copy_to_clipboard.html' %}
    </div>
    <hr>
</div>

<div class="container-fluid my-5">
    <div class="row col-12">

        <div class="col-2">
        </div>

        <div class="col-8">
            <form class="comment-form mb-5" method="post" data-post="{{ post.id }}">
                {% csrf_token %}
                <textarea class="form-control mb-2" name="content" placeholder="Add/Write a comment" rows="4"></textarea>
                <button class="btn btn-primary" type="submit">Comment</button>
            </form>

            {% for comment in comments %}
                <div class="mb-4">
                    <div id="comment-head" class="row bg-gray-secondary p-2">
                        <div class="col-8">
                            <img style="height:3rem;" src="{{comment.author.profile.image.url}}" class="rounded-circle"/>
                            <span class="fs-4"> {{ comment.author }}</span>
                        </div>
                        <div class="col-4 d-flex justify-content-end p-1">
                            <div class="dropdown">
                                <button class="btn" id="dropdownMenuButton2" data-bs-toggle="dropdown" aria-expanded="false"><i class="fa-solid fa-ellipsis-vertical"></i></button>
                                <ul class="dropdown-menu dropdown-menu-dark" aria-labelledby="dropdownMenuButton2">
                                    {% if request.user == comment.author %}<li><a class="dropdown-item" href="{% url 'edit_comment' comment.pk %}">Edit</a></li>{% endif %}

                                    {% if request.user.is_superuser or request.user == comment.author %}<li><a class="dropdown-item" href="{% url 'delete_comment' comment.pk %}">Delete</a></li>{% endif %}
                                    
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item active" href="#">Separated link</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div id="comment" class="position-relative bg-gray p-2" style="">
                    
                        <pre>{{ comment.content }}</pre>

                        <span id="time-stamp">{{ comment.created_at }}</span>
                    </div>
                </div>

            {% empty %}
                <p>No comments yet.</p>
            {% endfor %}
        </div>


        <div class="col-2">
        </div>
        
    </div>
</div>

<form method="post">
    {% comment %} {% csrf_token %}
    {{ form }}
    <button type="submit">Submit</button> {% endcomment %}
</form>

{% include 'footer.html' %}

<script>//getting all exmple sentences li elements and adding class .example to each
    var post_content = document.getElementById("post-content");
    var li_arr = post_content.getElementsByTagName("li");
    for (li in li_arr) {
        li_arr[li].classList.add("example")
    }
</script>
<script>//highlighting the texts by replacing within li elems
    var fill_values = "{{post.fill_values}}"
    var target_vals = fill_values.split(",");
    var element = document.getElementsByClassName("example");
    for (line in element) {
        for (tvx in target_vals) {
            line_patt = new RegExp(target_vals[tvx],"gi")
            element[line].innerHTML = element[line].innerHTML.replace(line_patt, `<span style='color:#0d6efd;'>${target_vals[tvx]}</span>`);
        }
    }
</script>

<script>//insert select element
    var exercise = document.getElementById("exercise"); //parent element of questions
    var questions = exercise.getElementsByTagName("li"); //question elements array
    var exchoices = [];
    `{% for ex in post.exercise_set.all %}${exchoices.push("{{ex.choice}}")}{% endfor %}`;
    // RegExp
    var target_vals_join = target_vals.join("|");
    var reg_patt = new RegExp("\\b"+target_vals_join+"\\b","gi")
    // end RegExp
    
    for (line in questions) {
        questions[line].innerHTML = questions[line].innerHTML.replace(reg_patt, sel());
        
        function sel(){
            var select = `<select id="q-${line}"><option selected="selected"></option>`
            for (let x of exchoices[line].split(",")) {
                select += `<option value="${x}">${x}</option>`
            }
            select += `</select>`
            return ` ${select} `
        };
    }
</script>

<script>
    var q_arr = [];
    {//q_arr
        `{% for x in post.exercise_set.all %}
            ${q_arr.push('{{x.question}}')}
        {% endfor %}`;
    }
    var q_count = q_arr.length;//`{{post.exercise_set.count}}`; //length of questions
    
    var pre_values = [] //answer values
    for ( let x in q_arr ) {
        var prechoice = exchoices[x].split(",")
        for ( let y of prechoice ) {
            let preReg = new RegExp("\\b"+y+"\\b","gi")
            if (q_arr[x].toLowerCase().search(preReg) >= 0) {
                pre_values.push(y)
            }
        }
    };

    var val_array = [];
    var exam = 0;

    function check() {
        //getting selected option values of each select element
        for (let vl=0; vl < q_count; vl++) {
            var e = document.getElementById("q-"+vl);
            val_array.push(e.value)
            if (e.value == pre_values[vl]) { exam += 1 };
        }

        console.log("overall:",val_array.join("") == pre_values.join("")) // returns true or false based on 100% correct result
        console.log("val_array:",val_array)
        console.log("pre_values:",pre_values)
        console.log("exchoices:",exchoices)

        //for BSModal
        q_arr_html = []
        for (q in q_arr){
            q = parseInt(q)
            res_class = val_array[q]==pre_values[q]?"text-success":"text-danger";
            res_ic = val_array[q]==pre_values[q]?`<i class="fa-solid fa-circle-check"></i>`:`<i class="fa-solid fa-circle-xmark"></i>`;
            q_arr_html.push(`<div class="${res_class}">${res_ic} ${q+1}. ${q_arr[q]}</div>`)
        }
        var exmod = document.getElementById("modal-body")
        exmod.innerHTML = `
            <div class="text-center">
                <div class="fs-3">You got ${exam} out of ${q_count}</div>
            </div>
            <hr>
            <div class="mb-4">${q_arr_html.join("")}</div>

        `;

        exam = 0;// reset the value
        val_array = [];

    }
</script>
<script src="/static/js/web/jquery-3.6.3.min.js"></script>
<script src="/static/js/web/bootstrap.bundle.min.js"></script>
{% endblock body %}